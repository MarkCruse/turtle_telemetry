<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Turtle Tracking</title>
    <link rel="stylesheet" href="css/styles.css">

</head>

<body>
    <div id="map"></div>
    <h1>Turtle Tracking 1997-2017</h1>
    <h2></h2>
    <h3></h3>
    <input type="range" class="slider">
    <div id="year-value"></div>
    <div class="footer"><b><!--About:-->Last update: </b>3-22-2017 1200&nbsp;&nbsp;</b> <br/>
        <b>Data source:&nbsp;&nbsp;</b><a href="http://seamap.env.duke.edu/swot' target=" _blank "">The State of the World's Sea Turtles</a>
        <br/>
        <b>Map designed by:</b>&nbsp;&nbsp;Mark Cruse - March 2017
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/0.9.0/simple_statistics.min.js"></script> -->
    <!-- only needed for jenks et al -->


    <script type="text/javascript">
        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var width = 960,
            height = 580;

        var projection = d3.geo.mercator()
            // // .scale(1200)                        // play with the scale until it's 'zoomed' about right
            .translate([width / 2, height / 2]); // center the svg (0,0 is top, left)

        var geoPath = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g");

        var g = svg.append("g");

        svg.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height);

        var radius,
            zoom;

        queue()
            .defer(d3.json, "data/world-110m2.json")
            .defer(d3.csv, "data/obis_seamap_20170305_200629_custom_1997-2017.csv")
            .await(makeMap); //sends error and the next item in function


        function makeMap(error, topology, year) {

            g.append("path")
                .datum(topojson.feature(topology, topology.objects.countries))
                .attr("d", geoPath)
                .attr("class", "topology");

            var dataYr = [], //array to hold years
                dataName = [],
                datum;

            year.forEach(function(year) {
                dataYr.push(year.year); //load year to array
                dataName.push(year.common_name);
            });

            function onlyUnique(value, index, self) { //find only the unique values
                return self.indexOf(value) === index;
            }
            var unique = dataName.filter(onlyUnique); //contains no dups(unique)
            unique.sort(); //sort the unique name to alphabetise

            //Set legend color and points
            var colors = ["coral", "yellow", "red", "green", "purple", "darkcyan"];
            var legend_labels = [unique[5], unique[4], unique[3], unique[2], unique[1], unique[0]];

            var turtle_name = d3.scale.category20()
                .domain(legend_labels)
                .range(colors);

            // get the start year and end year range
            var min = Math.min.apply(Math, dataYr), //get the min year
                max = Math.max.apply(Math, dataYr); //get the max year

            radius = d3.scale.sqrt()
                .domain([min, max])
                .range([2, 30]);


            var track = g.selectAll("circle")
                .data(year)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    d.position = projection([d.lon, d.lat])
                    if (d.position) {
                        return d.position[0];
                    }
                })
                .attr("cy", function(d) {
                    if (d.position) {
                        return d.position[1];
                    }
                })
                .attr("r", function(d) {
                    return 3
                })
                .attr("class", "point-turtle")
                //end plotting points to map

                .on("mouseover", function(d) { // listener for objects
                    d3.select(this).transition().duration(300).style("opacity", 1);
                    // tooltip starts here
                    div.transition().duration(300)
                        .style("opacity", 1)
                    div.text(d.common_name + '  ' + d.date + '')
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 30) + "px");
                    //tooltip ends
                    d3.select("h2").text(d.common_name + ' '); //insert the name of the turtle hovered over into the h2 element
                    d3.select("h3").text(d.date + ' ' + d.provider_name); //insert the date of point hovered over into the h3 element
                    d3.select(this).attr("class", "hover"); //apply CSS class rules
                })
                .on("mouseout", function(d) {
                    d3.select(this)
                        .transition().duration(300)
                        .style("opacity", 0.8);
                    div.transition().duration(300)
                        .style("opacity", 0);
                    d3.select("h2").text("");
                    d3.select(this).attr("class", "point-turtle");
                    d3.select("h3").text("");
                    d3.select(this).attr("class", "point-turtle");
                });

            var output = d3.select("#year-value").text(min + "-" + max);

            d3.select(".slider")
                .attr("min", min)
                .attr("max", max)
                .attr("value", max)
                .attr("step", 1)
                .on("input", function() {
                    update(this.value);
                });

            function update(val) {
                output.text(Number(val));
                track.attr("display", function(d) {
                    if (val == 2017) {
                        var output = d3.select("#year-value").text(min + "-" + max);
                        return "all";
                    } else if (val != d.year) {
                        return "none";
                    }
                })
            } //end function update

            zoom = d3.behavior.zoom()
                .scaleExtent([1, 16])
                .on("zoom", function() {
                    g.attr("transform", "translate(" +
                        d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")");
                    radius.range([2 / d3.event.scale, 30 / d3.event.scale]);
                    track
                        .attr('d', geoPath.pointRadius(function(d) {
                            return radius(d.year);
                        }))
                        .attr("stroke-width", (1 / d3.event.scale) * 2 + "px");
                });

            svg.call(zoom);

            // ************* Begin Legend *************
            var legend = svg.selectAll("g.legend")
                .data(unique)
                .enter() //create placeholders
                .append("g") //   replace placeholders with g elements
                .attr("class", "legend"); // and give each g a legend class

            var ls_w = 20, //width of legend
                ls_h = 15; //height of legend

            legend.append("rect")
                .attr("x", width - 110) //location of legend on map
                .attr("y", function(d, i) {
                    return height - (i * ls_h) - 2 * ls_h;
                })
                .attr("width", ls_w)
                .attr("height", ls_h)
                .style("fill", function(d, i) {
                    return turtle_name(d);
                })
                .style("opacity", 0.8);

            legend.append("text")
                .attr("x", width - 80) //location of legend text on map
                .attr("y", function(d, i) {
                    return height - (i * ls_h) - ls_h - 4;
                })
                .text(function(d, i) {
                    return legend_labels[i];
                });

        };
    </script>
</body>

</html>
