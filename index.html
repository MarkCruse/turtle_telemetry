<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Turtle Tracking</title>
    <link rel="stylesheet" href="css/styles.css">

</head>

<body>
    <div id="map"></div>
    <h1>Turtle Tracking 1997-2017</h1>
    <h2></h2>
    <h3></h3>
    <input type="range" class="slider">
    <div id="year-value"></div>
    <div class="footer"><b>About:</b>&nbsp;&nbsp;</b> <br/>
       <b>Data source:&nbsp;&nbsp;</b><a href="http://seamap.env.duke.edu/swot' target="_blank"">The State of the World's Sea Turtles</a>
       <br/>
       <b>Map designed by:</b>&nbsp;&nbsp;Mark Cruse - March 2017
 </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/0.9.0/simple_statistics.min.js"></script>

    <script type="text/javascript">
        var width = 900,
            height = 600;

        var svg = d3.select("#map") // put svg in the map div element
            .append("svg") // create and append a new svg element to it
            .attr("width", width) // give the svg width
            .attr("height", height); // give the svg height

        var projection = d3.geo.mercator()
            // .scale(1200)                        // play with the scale until it's 'zoomed' about right
            .translate([width / 2, height / 2]); // center the svg (0,0 is top, left)
        var geoPath = d3.geo.path() //  create a new geo path generator
            .projection(projection); // assign the project we just created to it

        queue()
            .defer(d3.json, "data/world-110m2.json")
            .defer(d3.csv, "data/obis_seamap_20170305_200629_custom_1997-2017.csv")
            .await(makeMap); //sends error and the next item in function


        function makeMap(error, topology, year) {
            var data = [];
            year.forEach(function(year) {
                data.push(year.year); //load year to array
            });
            // get the start year and end year range
            var min = Math.min.apply(Math, data),  //get the min year
               max =  Math.max.apply(Math, data); //get the max year



               // load the topology features from either json or topoJSON data and append to map
               svg.append("g") // create and append a new SVG 'g' element to the svg
                   .selectAll("path")
                   .data(topojson.feature(topology, topology.objects.countries).features)
                   .enter()
                   .append("path")
                   .attr("d", geoPath)
                   .attr("class", "topology");

            var track = svg.append("g") //begin plotting points to map
                .selectAll("circle")
                .data(year)
                .enter()
                .append("circle")
                .attr("cx", function(d) {
                    d.position = projection([d.lon, d.lat])
                    if (d.position) {
                        return d.position[0];
                    }
                })
                .attr("cy", function(d) {
                    if (d.position) {
                        return d.position[1];
                    }
                })
                .attr("r", function(d) {
                    return 1
                })
                .attr("class", "point-turtle");
                //end plotting points to map

          var output = d3.select("#year-value").text(min+"-"+max);

          d3.select(".slider")
               .attr("min", min)
               .attr("max", max)
               .attr("value", max)
               .attr("step", 1)
               .on("input", function() {
                    update(this.value);
               });


          function update(val){
               output.text(Number(val));
               track.attr("display", function(d) {
                    if(val == 2017){
                         var output = d3.select("#year-value").text(min+"-"+max);
                         return "all";
                    } else if(val != d.year){
                         return "none";
                    }
               })
          }

        }; // end makeMap function
    </script>
</body>

</html>
